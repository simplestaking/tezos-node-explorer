<div class="state-machine w-100 overflow-hidden"
     *ngIf="state$ | async as stateMachine">
  <!--  <div fxFlex="40px" class="border-bottom tabs d-flex align-center font-12">-->
  <!--    <div *ngFor="let tab of tabs"-->
  <!--         (click)="activeTab = tab"-->
  <!--         class="text-white-7 margin-right-10 pointer"-->
  <!--         [class.active]="activeTab === tab">-->
  <!--      {{ tab }}-->
  <!--    </div>-->
  <!--  </div>-->
  <div class="d-flex flex-column h-100">
    <div class="filters-container" fxFlex="76px">

      <div class="active-filters-row">
        <button class="add-filters" mat-flat-button>
          <mat-icon svgIcon="filter" class="icon-14 margin-right-5 margin-left-5"></mat-icon>
          Active Filters
        </button>

        <div class="filters-content">
          <button *ngFor="let filter of activeFilters"
                  class="active"
                  mat-flat-button
                  (click)="filterByType(filter)">
            <span class="d-flex align-center flex-center">
              {{ filter }}
              <mat-icon svgIcon="close"
                        class="icon-12 margin-left-5"></mat-icon>
            </span>
          </button>
        </div>
      </div>

      <mat-accordion class="filters-accordion">
        <mat-expansion-panel [expanded]="true" hideToggle="true">
          <ng-template matExpansionPanelContent class="filters-content">
            <div class="filters-row">
              <span class="filters-label">Control</span>
              <button [class.active]="activeFilters.includes('connection') || !activeFilters.length"
                      (click)="filterByType('connection')">
                Connection
                <mat-icon svgIcon="close" class="icon-12 margin-left-5"></mat-icon>
              </button>
              <button [class.active]="activeFilters.includes('dnsLookup') || !activeFilters.length"
                      (click)="filterByType('dnsLookup')">
                DNS Lookup
                <mat-icon svgIcon="close" class="icon-12 margin-left-5"></mat-icon>
              </button>
              <button [class.active]="activeFilters.includes('wakeUp') || !activeFilters.length"
                      (click)="filterByType('wakeUp')">
                Wake Up
                <mat-icon svgIcon="close" class="icon-12 margin-left-5"></mat-icon>
              </button>
              <button [class.active]="activeFilters.includes('attempt') || !activeFilters.length"
                      (click)="filterByType('attempt')">
                Attempt
                <mat-icon svgIcon="close" class="icon-12 margin-left-5"></mat-icon>
              </button>
            </div>
          </ng-template>
        </mat-expansion-panel>
      </mat-accordion>

    </div>
    <div fxFlex="calc(100% - 76px)" class="d-flex flex-column w-100 flex-between">
      <div class="upper-container"
           [style.transition]="transition"
           [class.collapsed]="stateMachine.collapsedDiagram"
           [style.height]="stateMachine.collapsedDiagram
                           ? '32px'
                           : (stateMachine.diagramHeight ? stateMachine.diagramHeight + 'px' : '40%')">
        <div class="d-flex diagrams-container">
          <app-state-machine-diagram fxFlex="60" class="d-flex flex-column"></app-state-machine-diagram>
          <div fxFlex="40" class="border-left d-flex flex-column">
            <div fxFlex="35px" class="text-white-7 padding-10 font-12 border-bottom">
              <span class="text-white text-uppercase margin-right-10">Action Statistics</span>
              {{ stateMachine.actionStatistics.totalCalls | thousandTransform }}
              <span
                class="text-white-4">calls</span>
              Â· {{ stateMachine.actionStatistics.totalDuration | timeTransform: false: false: true }}
              <span class="text-white-4">total duration</span>
            </div>

            <div fxFlex="calc(100% - 35px)" class="overflow-auto"
                 *ngIf="stateMachine.actionStatistics.statistics.length">

              <div class="statistics padding-10">
                <div class="d-flex align-center">
                  <mat-icon svgIcon="arrow-down" class="icon-16"></mat-icon>
                  <span class="calls-label">Total duration</span>
                </div>
                <div fxLayout="row">
                  <div fxFlex="24px" fxLayout="column" fxLayoutGap="6px" class="y-steps padding-top-10">
                    <span *ngFor="let step of ySteps">{{ step }}</span>
                  </div>
                  <div fxFlex="calc(100% - 24px)" class="d-flex flex-column">
                    <div class="cols-wrap flex-row align-end d-flex">
                      <div *ngFor="let col of stateMachine.actionStatistics.statistics; let i=index"
                           [style.width.%]="100 / stateMachine.actionStatistics.statistics.length"
                           (mouseenter)="openDetailsOverlay(col, i, $event)"
                           (mouseleave)="detachOverlay()"
                           class="gr-col d-flex flex-column-reverse">
                        <div *ngFor="let square of [].constructor(col.durationSquares); let j=index"
                             [class.yellow-square]="j > 1 && j <= 3"
                             [class.red-square]="j > 3"
                             class="square"></div>
                      </div>
                    </div>
                  </div>
                </div>
                <div fxLayoutAlign="start center" class="margin-top-5" fxLayoutGap="8px">
                  <mat-icon svgIcon="arrow-right" class="icon-16"></mat-icon>
                  <span class="calls-label">Actions</span>
                </div>
              </div>

              <div class="statistics padding-10">
                <div class="d-flex align-center">
                  <mat-icon svgIcon="arrow-down" class="icon-16"></mat-icon>
                  <span class="calls-label">Number of calls</span>
                </div>
                <div fxLayout="row">
                  <div fxFlex="24px" fxLayout="column" fxLayoutGap="6px" class="y-steps padding-top-10">
                    <span *ngFor="let step of ySteps">{{ step }}</span>
                  </div>
                  <div fxFlex="calc(100% - 24px)" class="d-flex flex-column">
                    <div class="cols-wrap flex-row align-end d-flex">
                      <div *ngFor="let col of stateMachine.actionStatistics.statistics; let i=index"
                           [style.width.%]="100 / stateMachine.actionStatistics.statistics.length"
                           (mouseenter)="openDetailsOverlay(col, i, $event)"
                           (mouseleave)="detachOverlay()"
                           class="gr-col d-flex flex-column-reverse">
                        <div *ngFor="let square of [].constructor(col.callsSquares); let j=index"
                             [class.yellow-square]="j > 2 && j <= 5"
                             [class.red-square]="j > 5"
                             class="square"></div>
                      </div>
                    </div>
                  </div>
                </div>
                <div fxLayoutAlign="start center" class="margin-top-5" fxLayoutGap="8px">
                  <mat-icon svgIcon="arrow-right" class="icon-16"></mat-icon>
                  <span class="calls-label">Actions</span>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div *ngIf="!stateMachine.collapsedDiagram"
             class="resizer-element p-relative d-flex flex-center">
          <div class="mid-content d-flex flex-column align-center"
               resizer (resizeFinished)="onResizeFinished($event)">
            <mat-icon svgIcon="rounded-triangle" class="up icon-white-4 icon-10"></mat-icon>
            <div class="line"></div>
            <mat-icon svgIcon="rounded-triangle" class="down icon-white-4 icon-10"></mat-icon>
          </div>
        </div>
      </div>
      <div class="bottom-container flex-1" fxLayout.gt-sm="row" fxLayout.lt-md="column"
           [class.collapsed]="stateMachine.collapsedDiagram"
           [style.transition]="transition">
        <app-state-machine-table fxFlex.gt-sm="530px" fxFlex.lt-md="50%"></app-state-machine-table>
        <div fxFlex.gt-sm="calc(100% - 530px)" fxFlex.lt-md="50%">
          <app-state-machine-action-details></app-state-machine-action-details>
        </div>
      </div>
    </div>
  </div>
</div>

<ng-template #tooltipTemplate
             let-name="name"
             let-calls="calls"
             let-duration="duration">
  <div class="tooltip-template">
    <div class="text-white header">{{ name }}</div>
    <div>
      <span class="text-white">{{ calls | thousandTransform }}</span>
      Calls
    </div>
    <div>
      <span class="text-white">{{ duration | timeTransform: false: false: true }}</span>
      Duration
    </div>
  </div>
</ng-template>
